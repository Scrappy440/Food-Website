<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Meal - BiteThat!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="logo-text">
                <i class="fas fa-utensils"></i>
                <span>BiteThat!</span>
            </div>
            <div class="nav-buttons">
                <a href="{{ url_for('home') }}" class="btn btn-home">Home</a>
                <a href="{{ url_for('logout') }}" class="btn btn-sec">Log out</a>
            </div>
        </div>
    </nav>
    
    <main class="log-meal-page">
        <div class="log-meal-wrapper">
            <div class="page-header-simple">
                <h1>Add Food</h1>
                <div class="date-navigation">
                    <button type="button" class="date-nav-btn" id="prev-date-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <p class="date-display" id="current-date"></p>
                    <button type="button" class="date-nav-btn" id="next-date-btn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="meal-type-selector">
                <button type="button" class="meal-type-btn active" data-meal="breakfast">Breakfast</button>
                <button type="button" class="meal-type-btn" data-meal="lunch">Lunch</button>
                <button type="button" class="meal-type-btn" data-meal="dinner">Dinner</button>
                <button type="button" class="meal-type-btn" data-meal="snack">Snacks</button>
            </div>
            <!-- Updated for autocomplete feature 11/10
                <input type="text" id="food-search" class="food-search-input" placeholder="Search for food...">
                <button class="quick-add-btn" onclick="toggleQuickAdd()">+ Quick Add</button>
            </div>
             -->
            <div class="food-search-section">
                <div class="autocomplete-wrapper">
                    <input type="text" id="food-search" class="food-search-input" placeholder="Search for food...">
                    <div id="autocomplete-results" class="autocomplete-results"></div>
                </div>
                <button class="quick-add-btn" onclick="toggleQuickAdd()">+ Quick Add</button>
            </div>


            <div id="quick-add-form" class="quick-add-form" style="display: none;">
                <form action="{{ url_for('log_meal') }}" method="POST" id="meal-form">
                    <input type="hidden" name="meal_type" id="selected-meal-type" value="breakfast">
                    <input type="hidden" name="meal_date" id="meal-date">
                    
                    <div class="foods-list">
                        <div class="food-item">
                            <div class="food-item-header">
                                <input type="text" name="ingredient_name[]" class="food-name-input" placeholder="Food name" required>
                                <button type="button" class="remove-food-btn" onclick="this.closest('.food-item').remove(); updateTotals();">Ã—</button>
                            </div>
                            <div class="nutrition-inputs">
                                <div class="nutrition-input-group">
                                    <label>Serving</label>
                                    <input type="text" name="quantity[]" placeholder="1 cup">
                                </div>
                                <div class="nutrition-input-group">
                                    <label>Calories</label>
                                    <input type="number" name="calories[]" placeholder="0" min="0" onchange="updateTotals()">
                                </div>
                                <div class="nutrition-input-group">
                                    <label>Protein (g)</label>
                                    <input type="number" name="protein[]" placeholder="0" min="0" step="0.1" onchange="updateTotals()">
                                </div>
                                <div class="nutrition-input-group">
                                    <label>Carbs (g)</label>
                                    <input type="number" name="carbs[]" placeholder="0" min="0" step="0.1" onchange="updateTotals()">
                                </div>
                                <div class="nutrition-input-group">
                                    <label>Fat (g)</label>
                                    <input type="number" name="fat[]" placeholder="0" min="0" step="0.1" onchange="updateTotals()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="add-food-btn" onclick="addFood()">+ Add Another Food</button>
                    
                    <div class="meal-summary">
                        <h3>Meal Totals</h3>
                        <div class="totals-row">
                            <div class="total-item">
                                <span class="total-value" id="total-calories">0</span>
                                <span class="total-label">Calories</span>
                            </div>
                            <div class="total-item">
                                <span class="total-value" id="total-carbs">0g</span>
                                <span class="total-label">Carbs</span>
                            </div>
                            <div class="total-item">
                                <span class="total-value" id="total-fat">0g</span>
                                <span class="total-label">Fat</span>
                            </div>
                            <div class="total-item">
                                <span class="total-value" id="total-protein">0g</span>
                                <span class="total-label">Protein</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="toggleQuickAdd()">Cancel</button>
                        <button type="submit" class="save-btn">Add to Diary</button>
                    </div>
                </form>
            </div>
            
            <div class="daily-summary">
                <h2>Today's Summary</h2>
                <div class="progress-bars">
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>Calories</span>
                            <span class="progress-values"><strong id="daily-calories">{{ totals.kcal|round(0)|int }}</strong> / <span id="daily-goal">2000</span></span>
                        </div>
                        <div class="progress-bar">
                            <div id="daily-progress-fill" class="progress-fill" style="width: {% if totals.kcal %}{{ (totals.kcal / 2000 * 100)|round(1) }}%{% else %}0%{% endif %}"></div>
                        </div>
                    </div>
                    <div class="macro-grid">
                        <div class="macro-item">
                            <span class="macro-label">Carbs</span>
                            <span id="daily-carbs" class="macro-value">{{ totals.carbs|round(1) }}g</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">Fat</span>
                            <span id="daily-fat" class="macro-value">{{ totals.fat|round(1) }}g</span>
                        </div>
                        <div class="macro-item">
                            <span class="macro-label">Protein</span>
                            <span id="daily-protein" class="macro-value">{{ totals.protein|round(1) }}g</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- After quick adding meals, show 4 category-specific diary cards -->
            <div class="diary-section">
                <h2>Meal Diary</h2>
                <div class="diary-grid">
                    <div class="diary-column">
                        <h4><i class="fas fa-coffee"></i> Breakfast</h4>
                        <div id="diary-breakfast" class="diary-list">
                            {% for meal in meals_by_type.get('breakfast', []) %}
                            <div class="diary-meal" data-meal-id="{{ meal.id }}">
                                <div class="diary-meal-header">
                                    <h5>{{ meal.meal_date.strftime('%m/%d') }}</h5>
                                    <div class="meal-actions">
                                        <button type="button" class="edit-meal-btn" data-meal-id="{{ meal.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button type="button" class="delete-meal-btn" data-meal-id="{{ meal.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <ul class="food-items-list">
                                    {% for item in meal['items'] %}
                                    <li class="food-item-entry">
                                        <span class="food-name">{{ item.ingredient_name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="diary-column">
                        <h4><i class="fas fa-utensils"></i> Lunch</h4>
                        <div id="diary-lunch" class="diary-list">
                            {% for meal in meals_by_type.get('lunch', []) %}
                            <div class="diary-meal" data-meal-id="{{ meal.id }}">
                                <div class="diary-meal-header">
                                    <h5>{{ meal.meal_date.strftime('%m/%d') }}</h5>
                                    <div class="meal-actions">
                                        <button type="button" class="edit-meal-btn" data-meal-id="{{ meal.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button type="button" class="delete-meal-btn" data-meal-id="{{ meal.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <ul class="food-items-list">
                                    {% for item in meal['items'] %}
                                    <li class="food-item-entry">
                                        <span class="food-name">{{ item.ingredient_name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="diary-column">
                        <h4><i class="fas fa-drumstick-bite"></i> Dinner</h4>
                        <div id="diary-dinner" class="diary-list">
                            {% for meal in meals_by_type.get('dinner', []) %}
                            <div class="diary-meal" data-meal-id="{{ meal.id }}">
                                <div class="diary-meal-header">
                                    <h5>{{ meal.meal_date.strftime('%m/%d') }}</h5>
                                    <div class="meal-actions">
                                        <button type="button" class="edit-meal-btn" data-meal-id="{{ meal.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button type="button" class="delete-meal-btn" data-meal-id="{{ meal.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <ul class="food-items-list">
                                    {% for item in meal['items'] %}
                                    <li class="food-item-entry">
                                        <span class="food-name">{{ item.ingredient_name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="diary-column">
                        <h4><i class="fas fa-cookie-bite"></i> Snacks</h4>
                        <div id="diary-snack" class="diary-list">
                            {% for meal in meals_by_type.get('snack', []) %}
                            <div class="diary-meal" data-meal-id="{{ meal.id }}">
                                <div class="diary-meal-header">
                                    <h5>{{ meal.meal_date.strftime('%m/%d') }}</h5>
                                    <div class="meal-actions">
                                        <button type="button" class="edit-meal-btn" data-meal-id="{{ meal.id }}" title="Edit"><i class="fas fa-edit"></i></button>
                                        <button type="button" class="delete-meal-btn" data-meal-id="{{ meal.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <ul class="food-items-list">
                                    {% for item in meal['items'] %}
                                    <li class="food-item-entry">
                                        <span class="food-name">{{ item.ingredient_name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>

<!--Autosuggest Didnt work, needs new script maybe 11/9-->
<!-- I hate Javascript -Y  -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("food-search");
        const resultsDiv = document.getElementById("autocomplete-results");
        async function searchFoods(query) {
        const res = await fetch(`/autocomplete?query=${encodeURIComponent(query)}`);
        return res.json();
    }

    async function getFoodDetails(id) {
        const res = await fetch(`/food/${id}`);
        return res.json();
    }
    //Decision: Starts auto after 2 chars
    searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();
        resultsDiv.innerHTML = "";
        if (query.length < 2) return;

        const foods = await searchFoods(query);
        foods.forEach(f => {
            const div = document.createElement("div");
            div.className = "suggestion";
            div.textContent = f.brand ? `${f.name} (${f.brand})` : f.name;
            div.onclick = async () => {
                // Fill the top search box with chosen name (NOT working only suggests under)
                searchInput.value = f.name;
                resultsDiv.innerHTML = "";

                const data = await getFoodDetails(f.id);
                if (data.error) return alert("Food not found.");

                // Autofill button
                const firstFood = document.querySelector(".food-item");
                if (firstFood) {
                    firstFood.querySelector(".food-name-input").value = data.name;
                    firstFood.querySelector("input[name='quantity[]']").value =
                        data.serving_size_g ? `${data.serving_size_g} g` : "";
                    firstFood.querySelector("input[name='calories[]']").value = data.kcal ?? 0;
                    //firstFood.querySelector("input[name='calories[]']").value = data.cal ?? 0;
                    firstFood.querySelector("input[name='protein[]']").value = data.protein_g ?? 0;
                    firstFood.querySelector("input[name='carbs[]']").value = data.carbs_g ?? 0;
                    firstFood.querySelector("input[name='fat[]']").value = data.fat_g ?? 0;
                    updateTotals();
                }
            };
            resultsDiv.appendChild(div);
        });
    });

    // Hide autocomplete when not cliked on
    document.addEventListener("click", e => {
        if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
            resultsDiv.innerHTML = "";
        }
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // set today's date into hidden input
  const mealDate = document.getElementById('meal-date');
  if (mealDate && !mealDate.value) mealDate.value = new Date().toISOString().slice(0,10);

  // wire meal-type buttons to hidden input
  document.querySelectorAll('.meal-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('selected-meal-type').value = btn.dataset.meal;
      document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  const mealForm = document.getElementById('meal-form');
  const defaultMealFormAction = mealForm ? mealForm.action : '/logmeal';
  let currentlyEditingId = null;
  
  if (!mealForm) return;

  mealForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(mealForm);
    try {
      const res = await fetch(mealForm.action, { method: 'POST', body: fd, headers: {'X-Requested-With':'XMLHttpRequest'} });
      const data = await res.json();
      if (!data.success) return alert(data.error || 'Failed to save meal.');

      // append meal to category-specific diary
      const m = data.meal;
      const cat = (m.meal_type || 'snack').toLowerCase();
      const containerList = document.getElementById(`diary-${cat}`) || document.getElementById('diary-snack');
      const existing = document.querySelector(`[data-meal-id="${m.id}"]`);
      
      if (existing) {
        // On edit, just reload - server will recalculate everything
        window.location.reload();
      } else {
        // For new meals, add to UI and update totals
        const container = createMealCard(m);
        containerList.insertBefore(container, containerList.firstChild);
        if (m.totals) {
          updateDailySummary(m.totals);
        }
      }

      // clear editing state
      clearEditState();

      mealForm.reset();
      mealForm.action = defaultMealFormAction;
      document.querySelector('.save-btn').textContent = 'Add to Diary';
      document.querySelector('.meal-type-btn[data-meal="breakfast"]')?.click();
      mealDate.value = new Date().toISOString().slice(0,10);
      
      // close quick add form
      const quickAdd = document.getElementById('quick-add-form');
      if (quickAdd) quickAdd.style.display = 'none';
    } catch (err) {
      alert('Error saving meal: ' + err.message);
    }
  });

  function createMealCard(m) {
    const container = document.createElement('div');
    container.className = 'diary-meal';
    container.dataset.mealId = m.id;
    
    const header = document.createElement('div');
    header.className = 'diary-meal-header';
    
    const h = document.createElement('h5');
    // Parse date string as local date (YYYY-MM-DD)
    const dateStr = m.meal_date.split('T')[0]; // Get just the date part
    const [year, month, day] = dateStr.split('-');
    h.textContent = `${month.padStart(2,'0')}/${day.padStart(2,'0')}`;
    
    const actions = document.createElement('div');
    actions.className = 'meal-actions';
    actions.innerHTML = `
      <button type="button" class="edit-meal-btn" data-meal-id="${m.id}" title="Edit"><i class="fas fa-edit"></i></button>
      <button type="button" class="delete-meal-btn" data-meal-id="${m.id}" title="Delete"><i class="fas fa-trash"></i></button>
    `;
    
    header.appendChild(h);
    header.appendChild(actions);
    container.appendChild(header);
    
    const ul = document.createElement('ul');
    ul.className = 'food-items-list';
    (m.items||[]).forEach(it => {
      const li = document.createElement('li');
      li.className = 'food-item-entry';
      li.innerHTML = `<span class="food-name">${escapeHtml(it.ingredient_name)}</span>`;
      ul.appendChild(li);
    });
    container.appendChild(ul);
    
    return container;
  }

  function updateDailySummary(totals) {
    const kcalEl = document.getElementById('daily-calories');
    const carbsEl = document.getElementById('daily-carbs');
    const fatEl = document.getElementById('daily-fat');
    const protEl = document.getElementById('daily-protein');
    const progressFill = document.getElementById('daily-progress-fill');
    const goal = parseFloat(document.getElementById('daily-goal').textContent) || 2000;
    
    // Ensure all values are numbers
    const currentKcal = parseFloat(kcalEl.textContent) || 0;
    const newKcal = parseFloat(totals.kcal) || 0;
    
    // Add new meal totals to current values
    if (kcalEl) kcalEl.textContent = Math.round(currentKcal + newKcal);
    
    if (carbsEl) {
      const currentCarbs = parseFloat(carbsEl.textContent) || 0;
      const newCarbs = parseFloat(totals.carbs) || 0;
      carbsEl.textContent = (currentCarbs + newCarbs).toFixed(1) + 'g';
    }
    if (fatEl) {
      const currentFat = parseFloat(fatEl.textContent) || 0;
      const newFat = parseFloat(totals.fat) || 0;
      fatEl.textContent = (currentFat + newFat).toFixed(1) + 'g';
    }
    if (protEl) {
      const currentProt = parseFloat(protEl.textContent) || 0;
      const newProt = parseFloat(totals.protein) || 0;
      protEl.textContent = (currentProt + newProt).toFixed(1) + 'g';
    }
    
    if (progressFill && kcalEl) {
      const pct = Math.min(100, (parseFloat(kcalEl.textContent) / goal) * 100);
      progressFill.style.width = pct + '%';
    }
  }

  function clearEditState() {
    const formWrap = document.getElementById('quick-add-form');
    if (formWrap) formWrap.classList.remove('editing');
    if (currentlyEditingId) {
      const prev = document.querySelector(`[data-meal-id="${currentlyEditingId}"]`);
      if (prev) prev.classList.remove('editing');
    }
    currentlyEditingId = null;
    if (mealForm) mealForm.action = defaultMealFormAction;
    const saveBtn = document.querySelector('.save-btn');
    if (saveBtn) saveBtn.textContent = 'Add to Diary';
  }

  function escapeHtml(s) {
    return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // handle clicks on edit/delete buttons (delegated)
  document.addEventListener('click', async (e) => {
    // Edit button
    const editBtn = e.target.closest('.edit-meal-btn');
    if (editBtn) {
      const mealId = editBtn.dataset.mealId;
      if (!mealId) return;
      try {
        const res = await fetch(`/meal/${mealId}`);
        const data = await res.json();
        if (!data.success) return alert(data.error || 'Failed to load meal');
        openMealInEditor(data.meal);
      } catch (err) {
        alert('Error fetching meal: ' + err.message);
      }
      return;
    }
    
    // Delete button
    const deleteBtn = e.target.closest('.delete-meal-btn');
    if (deleteBtn) {
      const mealId = deleteBtn.dataset.mealId;
      if (!mealId) return;
      if (!confirm('Are you sure you want to delete this meal?')) return;
      try {
        const res = await fetch(`/meal/${mealId}/delete`, { method: 'POST', headers: {'X-Requested-With':'XMLHttpRequest'} });
        const data = await res.json();
        if (!data.success) return alert(data.error || 'Failed to delete meal');
        
        // remove from UI
        const card = document.querySelector(`[data-meal-id="${mealId}"]`);
        if (card) card.remove();
        
        // refresh page to update totals (or compute locally if you have the meal data)
        window.location.reload();
      } catch (err) {
        alert('Error deleting meal: ' + err.message);
      }
      return;
    }
  });

  function clearFoodsList() {
    const foodsList = document.querySelector('.foods-list');
    foodsList.innerHTML = '';
  }

  function addFoodItemToForm(item) {
    addFood(); // uses script.js addFood to append a blank item
    const last = document.querySelectorAll('.food-item');
    const el = last[last.length - 1];
    if (!el) return;
    el.querySelector('.food-name-input').value = item.ingredient_name || '';
    el.querySelector("input[name='quantity[]']").value = item.quantity || '';
    el.querySelector("input[name='calories[]']").value = item.calories || 0;
    el.querySelector("input[name='protein[]']").value = item.protein || 0;
    el.querySelector("input[name='carbs[]']").value = item.carbs || 0;
    el.querySelector("input[name='fat[]']").value = item.fat || 0;
  }

  function openMealInEditor(meal) {
    const form = document.getElementById('quick-add-form');
    if (form.style.display === 'none') toggleQuickAdd();
    
    mealForm.action = `/meal/${meal.id}/update`;
    form.classList.add('editing');
    
    const entry = document.querySelector(`[data-meal-id="${meal.id}"]`);
    if (entry) {
      if (currentlyEditingId && currentlyEditingId !== meal.id) {
        const prev = document.querySelector(`[data-meal-id="${currentlyEditingId}"]`);
        if (prev) prev.classList.remove('editing');
      }
      entry.classList.add('editing');
    }
    currentlyEditingId = meal.id;
    
    document.getElementById('selected-meal-type').value = meal.meal_type || '';
    document.getElementById('meal-date').value = meal.meal_date ? meal.meal_date.split('T')[0] : new Date().toISOString().slice(0,10);
    
    clearFoodsList();
    (meal.items || []).forEach(it => addFoodItemToForm(it));
    updateTotals();
    
    document.querySelector('.save-btn').textContent = 'Save Changes';
  }

  // wire cancel button
  const cancelBtn = document.querySelector('.cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      clearEditState();
    });
  }
});
</script>
</body>
</html>
